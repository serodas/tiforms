CREATE SCHEMA TIFORMS;


CREATE TABLE TIFORMS.FORM (
    ID INTEGER GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1),
    NAME VARCHAR(200) NOT NULL,
    SLUG VARCHAR(200) NOT NULL,
    DESCRIPTION CLOB,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (ID)
);

CREATE UNIQUE INDEX "TIFORMS"."FORM_SLUG_IDX" 
ON "TIFORMS"."FORM" ("SLUG");

CREATE TABLE TIFORMS.FORMFIELD (
    ID INTEGER GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1),
    NAME VARCHAR(200) NOT NULL,
    LABEL VARCHAR(200) NOT NULL,
    FIELD_TYPE VARCHAR(50) NOT NULL,
    REQUIRED SMALLINT DEFAULT 1,
    DEPENDS_ON VARCHAR(200) DEFAULT NULL,
    DEPENDS_VALUE VARCHAR(200) DEFAULT NULL,
    API_URL VARCHAR(500) DEFAULT NULL,
    MIN_SEARCH_CHARS INTEGER DEFAULT 3,
    RESULT_KEY VARCHAR(100) DEFAULT NULL,
    LABEL_KEY VARCHAR(100) DEFAULT 'label',
    VALUE_KEY VARCHAR(100) DEFAULT 'value',
    DYNAMIC_OPTIONS_URL VARCHAR(500) DEFAULT NULL,
    DEPENDS_ON_FIELD VARCHAR(200) DEFAULT NULL,
    DYNAMIC_RESULT_KEY VARCHAR(100) DEFAULT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (ID)
);


CREATE TABLE TIFORMS.FORMSUBMISSION (
    ID INTEGER GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1),
    FORM_ID INTEGER NOT NULL,
    DATA CLOB,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (ID),
    FOREIGN KEY (FORM_ID) REFERENCES TIFORMS.FORM(ID) ON DELETE CASCADE
);

CREATE TABLE TIFORMS.FORM_FORMFIELDS (
    ID INTEGER GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1),
    FORM_ID INTEGER NOT NULL,
    FORMFIELD_ID INTEGER NOT NULL,
    FIELD_ORDER INTEGER DEFAULT 0,
    PRIMARY KEY (ID),
    FOREIGN KEY (FORM_ID) REFERENCES TIFORMS.FORM(ID) ON DELETE CASCADE,
    FOREIGN KEY (FORMFIELD_ID) REFERENCES TIFORMS.FORMFIELD(ID) ON DELETE CASCADE
);

CREATE TABLE "TIFORMS"."FORMFIELDOPTION" (
    "ID" INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    "FORMFIELD_ID" INTEGER NOT NULL,
    "VALUE" VARCHAR(200),
    "LABEL" VARCHAR(200),
    "ORDER" SMALLINT DEFAULT 0,
    FOREIGN KEY ("FORMFIELD_ID") REFERENCES "TIFORMS"."FORMFIELD"("ID")
);

CREATE TABLE TIFORMS.WEBHOOK_CONFIG (
    ID INTEGER GENERATED ALWAYS AS IDENTITY (START WITH 1, INCREMENT BY 1) PRIMARY KEY,
    FORM_ID INTEGER NOT NULL,
    NAME VARCHAR(100) NOT NULL,
    TYPE VARCHAR(20) NOT NULL DEFAULT 'api',
    URL VARCHAR(500) NOT NULL,
    IS_ACTIVE SMALLINT NOT NULL DEFAULT 1,
    HEADERS VARCHAR(4000) DEFAULT '{}',
    TIMEOUT INTEGER NOT NULL DEFAULT 30,
    RETRY_COUNT INTEGER NOT NULL DEFAULT 3,
    CONFIG VARCHAR(4000) DEFAULT '{}',
    CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (FORM_ID) REFERENCES TIFORMS.FORM(ID) ON DELETE CASCADE
);

CREATE TABLE TIFORMS.SUBMISSION_TASK_LOG (
    ID INTEGER GENERATED ALWAYS AS IDENTITY (START WITH 1, INCREMENT BY 1) PRIMARY KEY,
    FORMSUBMISSION_ID INTEGER NOT NULL,
    WEBHOOK_CONFIG_ID INTEGER NOT NULL,
    STATUS VARCHAR(20) NOT NULL DEFAULT 'pending',
    ATTEMPT INTEGER NOT NULL DEFAULT 1,
    RESPONSE_DATA VARCHAR(4000),
    ERROR_MESSAGE CLOB,
    STARTED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    COMPLETED_AT TIMESTAMP,
    FOREIGN KEY (FORMSUBMISSION_ID) REFERENCES TIFORMS.FORMSUBMISSION(ID) ON DELETE CASCADE,
    FOREIGN KEY (WEBHOOK_CONFIG_ID) REFERENCES TIFORMS.WEBHOOK_CONFIG(ID) ON DELETE CASCADE
);

ALTER TABLE BDSALUD.TBSOPORTES 
ADD COLUMN FIRMA_USUARIO VARCHAR(255) DEFAULT NULL;